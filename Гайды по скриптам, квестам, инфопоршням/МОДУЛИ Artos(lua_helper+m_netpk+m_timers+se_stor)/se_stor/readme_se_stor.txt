
-- -*- mode: lua; coding: windows-1251-dos -*-
se_stor.script (по материалам Malandrinus & xStream)
====================================================

Библиотека универсального хранилища данных произвольного размера
Основана на использовани нет-пакетов объектов.
Используется новый (относительно оригинала игры) тип объектов специального класса:
CUST_ST <-> clsid.custom_storage
создаваемый по новой секции 'custom_storage', описанной в конфигах игры.

Хранилище автоматически подстраивается под размер хранимых данных в таблице 'storehouse'.

Использовать 'storehouse' можно после загрузки в игру всех серверных об'ектов хранилища,
т.е. по факту загрузки игрового сервера (до загрузки клиентского об'екта актора!).

Запись (установка) переменной производится функцией set,
третий параметр - флаг необходимости проверки размера строки (опциональный параметр)
	se_stor.set(var_name, value, f_check)

Чтение (получение) переменной производится функцией get,
второй параметр - значение по-умолчанию (опциональный параметр):
	se_stor.get(var_name, default)
Если переменной не существует и не указано значение по-умолчанию, будет возвращен nil

Удаление переменных производится так же, как и установка - функцией set, как значение надо передать nil.
для удобства работы с данными хранилища в общую метатаблицу '_G' добавлены функции типа: SetVar|GetVar

Разрешено хранить переменные следующих типов:
	булевое - хранится как байт;
	
	число - хранится всегда как float,
		если требуется хранение очень больших чисел, то рекомендуется использовать
		хук приведения к строке: ""..1234567890 - передавать на вход set;
		
	строка - хранится как последовательность байт + нулевой символ (конец строки),
		ограничение на длину строки - 8000/16000 байт;
		
	таблицы (ПРОСТЫЕ! То есть: без метатаблиц, без нулевых символов и прочих бинарных данных,
		без рекурсий и только с простыми типами в ключах и значениях.
		Кроме того, объем таблицы ограничен - при сериализации строка должна умещаться в пакете,
		а значит ограничение примерно в 8000/16000 байт текста.
		Имеются два режима сериализации: с и без сжатия (компрессии) данных.

Дополнительно допустимо хранение данных типа 'vector' и 'CTime' (таймер игрового времени).
Также организована возможность хранения данных типа 'chunk' (бинарная последовательность).
	
Depends on:
	lua_extension.script - скрипт с расширениями Lua-функционала.
--/---------------------------------------------------------------------
Использование:
1. Скопировать в папку скриптов игры основной скрипт se_stor.script;
2. Добавить в конфиги (например в system.ltx) секцию [custom_storage];
3. Добавить новый класс CUST_ST <-> clsid.custom_storage в class_registrator.script;
4. Добавить в биндер актора алгоритм вызова события "сохранение игры" или функцию сохранения хранилища;
5. Добавить в _g.script инициализацию дополнительного функционала (lua_extension и доп.функций).
Примечание: В комплекте файлы с суффиксом '_ADD' являются строками, которые требуется добавить в соответствующие 'коренные' файлы.
--/---------------------------------------------------------------------
Пояснения (по пунктам):
1. Собственно сам модуль se_stor.script:
1.1 Скрипт se_stor.script имеет настройки, позволяющие использовать хранилище в разных версиях игры/модов (SoC|CS|CoP).
В данной версии комплекта скрипт полностью настроен на использование с оригинальной версией SoC (ТЧ патчи v1.0004 и выше).
1.2. Выводы в лог-файл дебаговой информации частично закомментированы.
При необходимости можно отключить полностью или наоборот, раскомментировав нужные строки.
1.3. Упоминаемая в комментариях опциональная 'система сигналов/событий' (event) используется в моде SIMBION (и возможно останется в LA),
и позволяет наиболее полно использовать все возможности хранилища и работы с ним.

2. Дополнительная секция 'custom_storage' может быть добавлена в любой файл с конфигами игры, читаемый движком на старте игры.
[custom_storage]
class = CUST_ST

3. Следует добавить в файл class_registrator.script в конец функции 'register' строки:
  if se_stor then
    cs_register (object_factory, "CGameObject", "se_stor.se_custom_storage", "CUST_ST", "custom_storage")
  end

4. В скрипте биндера актора (bind_stalker.script/bind_actor.script) требуется внести изменения помеченный в примере знаком #+#.
4.1. В методы 'save' и 'load' биндера необходимо добавить строки вызова соотв. функций (save/load) скрипта хранилища.
4.2. Если не предполанается изменение алгоритма хранения внешних модулей (погода, ...), то требуется организовать внешний доступ к биндеру актора.
4.3. В данном комплекте хранение данных модулями заданий, тайников, пси-зон вынесены в отдельные бинарные последовательности (chunks), что позволяет не вносить изменения в эти модули.
Однако необходимо описать в настройках хранилища (в таблице tPkChunks) внешние модули, в которых требуется сохранение данных в чанках (chunks).
Посоветовал бы все же сменить алгоритм хранения данных на хранение в виде субтаблиц в общей таблице 'storehouse'.

5. В _g.script ОБЯЗАТЕЛЬНО необходимо добавить строку (можно в самое начало) инициализации расширителя Lua-функционала (lua_extension.script):
  prefetch("lua_extension")
- из Lua-расширителя модуль хранилища используется различные функции (но не все, остальное может использоваться и другими модулями).
5.1. Функции интерфейса доступа к данным в хранилище (SetVar|GetVar|...) добавляются в конец файла или даже могут быть портированы в другой модуль (helper).
5.2. Также, для возможности хранения данных объектов типа вектор/таймер требуется добавить функции isVector|isCTime|isChunk.
5.3. Функции вывода в лог-файл и прерывания игры (abort) могут быть самыми различными, да и мною ужк давались различные варианты.
В данной сборке даны минимальные варианты для удобства настройки и проверки функционала модуля хранилища.

--/---------------------------------------------------------------------
Artos (09/09/2013)
